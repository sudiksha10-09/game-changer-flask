{% extends "base.html" %}

{% block content %}
<div class="container py-4 py-lg-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 serif-font mb-0">My Students</h1>
            <p class="text-muted">Manage your client relationships</p>
        </div>
        <a href="{{ url_for('coach_dashboard') }}" class="btn btn-outline-dark rounded-pill px-4">
            <i class="bi bi-arrow-left me-2"></i> Back to Dashboard
        </a>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-muted d-block mb-1">Total Students</small>
                        <h3 class="mb-0 fw-bold">{{ total_students }}</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-4 p-3">
                        <i class="bi bi-people text-primary fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-muted d-block mb-1">Active Students</small>
                        <h3 class="mb-0 fw-bold text-success">{{ active_students }}</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-4 p-3">
                        <i class="bi bi-person-check text-success fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm rounded-4 p-3">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <small class="text-muted d-block mb-1">Total Sessions</small>
                        <h3 class="mb-0 fw-bold">{{ total_sessions }}</h3>
                    </div>
                    <div class="bg-warning bg-opacity-10 rounded-4 p-3">
                        <i class="bi bi-calendar-check text-warning fs-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Students List -->
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-light border-0 py-3 px-4">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">All Students</h5>
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text bg-white border-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control border-0" placeholder="Search students...">
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            {% if students %}
                <div class="list-group list-group-flush">
                    {% for student_data in students %}
                    <div class="list-group-item border-0 border-bottom p-4 student-item">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <div class="d-flex align-items-center">
                                    {% if student_data.student.profile_image %}
                                        <img src="{{ url_for('static', filename='uploads/' + student_data.student.profile_image) }}"
                                             class="rounded-circle me-3" width="60" height="60" style="object-fit: cover;"
                                             onerror="this.onerror=null; this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div class="gradient-avatar avatar-md me-3" style="display: none;">
                                            <span class="avatar-initial">{{ student_data.student.name[0].upper() }}</span>
                                        </div>
                                    {% else %}
                                        <div class="gradient-avatar avatar-md me-3">
                                            <span class="avatar-initial">{{ student_data.student.name[0].upper() }}</span>
                                        </div>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-0 fw-bold">{{ student_data.student.name }}</h6>
                                        <small class="text-muted">{{ student_data.student.email }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="small">
                                    <div class="text-muted mb-1">Total Sessions</div>
                                    <strong class="fs-5">{{ student_data.total_sessions }}</strong>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="small">
                                    <div class="text-muted mb-1">Last Session</div>
                                    {% if student_data.last_session %}
                                        <strong>{{ student_data.last_session.strftime('%d %b %Y') }}</strong>
                                    {% else %}
                                        <span class="text-muted">Never</span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-3 text-end">
                                <button class="btn btn-outline-primary btn-sm rounded-pill" 
                                        type="button" 
                                        data-bs-toggle="collapse" 
                                        data-bs-target="#student{{ student_data.student.id }}">
                                    View History <i class="bi bi-chevron-down ms-1"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Collapsible Booking History -->
                        <div class="collapse mt-3" id="student{{ student_data.student.id }}">
                            <div class="card card-body bg-light border-0 rounded-3">
                                <h6 class="fw-bold mb-3">Booking History</h6>
                                {% if student_data.bookings %}
                                    <div class="table-responsive">
                                        <table class="table table-sm mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Time</th>
                                                    <th>Sport</th>
                                                    <th>Location</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for booking in student_data.bookings %}
                                                <tr>
                                                    <td>{{ booking.booking_date.strftime('%d %b %Y') }}</td>
                                                    <td>{{ booking.booking_time }}</td>
                                                    <td>{{ booking.sport }}</td>
                                                    <td>{{ booking.location or 'N/A' }}</td>
                                                    <td>
                                                        <span class="badge 
                                                            {% if booking.status == 'Confirmed' %}bg-success bg-opacity-10 text-success
                                                            {% elif booking.status == 'Rejected' %}bg-danger bg-opacity-10 text-danger
                                                            {% else %}bg-warning bg-opacity-10 text-warning{% endif %} rounded-pill">
                                                            {{ booking.status }}
                                                        </span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted small mb-0">No booking history available.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center p-5">
                    <i class="bi bi-people fs-1 text-muted opacity-25 mb-2"></i>
                    <p class="text-muted">No students yet</p>
                    <small class="text-muted">Students will appear here after they book sessions with you.</small>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
document.getElementById('searchInput')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const items = document.querySelectorAll('.student-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});
</script>
{% endblock %}
