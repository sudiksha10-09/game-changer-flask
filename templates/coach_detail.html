{% extends "base.html" %}
{% block content %}

<div class="container coach-detail-page py-4 py-lg-5">

  <!-- HEADER -->
  <div class="row g-4 mb-4 align-items-center">
    <div class="col-md-3 text-center text-md-start">
      <div class="coach-detail-avatar mb-3">
        {% if coach.profile_image %}
          <img src="{{ url_for('static', filename='uploads/' + coach.profile_image) }}"
               class="coach-detail-avatar-img">
        {% else %}
          <div class="coach-detail-avatar-fallback">
            <span>{{ coach.name[0].upper() }}</span>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="col-md-6">
      <h1 class="h3 serif-font mb-1">{{ coach.name }}</h1>
      <p class="text-muted">{{ coach.city }}, {{ coach.state }}</p>

      <div class="d-flex flex-wrap gap-2">
        {% for sport in coach.get_sports_list() %}
          <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill">
            {{ sport }}
          </span>
        {% endfor %}
      </div>
    </div>

    <div class="col-md-3 text-md-end text-center">
      <a href="#booking" class="btn btn-primary btn-sm rounded-pill w-100">
        Book a Session
      </a>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      {% include "partials/coach_story_and_reviews.html" ignore missing %}
    </div>

    <!-- BOOKING -->
    <div class="col-lg-4" id="booking">
      <div class="card border-0 shadow-sm rounded-4">
        <div class="card-header bg-primary bg-opacity-10 border-0 px-4 py-3">
          <h5 class="mb-0 text-primary">Book a Session</h5>
        </div>

        <div class="card-body px-4 pb-4 pt-3">
        {% if current_user.is_authenticated and current_user.role != 'coach' %}
          <form method="POST" action="{{ url_for('book_session', coach_id=coach.id) }}">

            <div class="mb-3">
              <label class="form-label small text-muted">Sport</label>
              <select name="sport" class="form-select form-select-sm" required>
                <option value="">Select sport</option>
                {% for sport in coach.get_sports_list() %}
                  <option value="{{ sport }}">{{ sport }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label small text-muted">Date</label>
              <input type="date" id="slot-date"
                     name="date"
                     class="form-control form-control-sm"
                     required>
            </div>

            <div class="mb-3">
              <label class="form-label small text-muted">Available Time Slots</label>
              <div id="slots-container" class="d-flex flex-wrap gap-2">
                <span class="text-muted small">Select a date</span>
              </div>
            </div>

            <input type="hidden" name="time" id="selected-time">

            <button type="submit" class="btn btn-primary w-100 rounded-pill">
              Confirm Booking
            </button>
          </form>
        {% else %}
          <p class="small text-muted">Login as a player to book.</p>
        {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const dateInput = document.getElementById("slot-date");
  const slotsContainer = document.getElementById("slots-container");
  const selectedTimeInput = document.getElementById("selected-time");

  if (!dateInput) return;
  dateInput.min = new Date().toISOString().split("T")[0];

  dateInput.addEventListener("change", async () => {
    slotsContainer.innerHTML = "Loading...";
    selectedTimeInput.value = "";

    const res = await fetch(`/api/coach/{{ coach.id }}/slots?date=${dateInput.value}`);
    const data = await res.json();

    slotsContainer.innerHTML = "";
    if (!data.slots?.length) {
      slotsContainer.innerHTML = "<span class='text-muted small'>No slots</span>";
      return;
    }

    data.slots.forEach(slot => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "btn btn-outline-primary btn-sm";
      btn.textContent = slot;
      btn.onclick = () => {
        document.querySelectorAll("#slots-container button")
          .forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedTimeInput.value = slot;
      };
      slotsContainer.appendChild(btn);
    });
  });
});
</script>

{% endblock %}
